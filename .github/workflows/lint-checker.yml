name: Lint PR Checker & Helper

on:
  pull_request_target:
    paths:
      - '**/build.sh'

permissions:
  issues: write
  pull-requests: write

jobs:
  lint:
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    name: Lint build.sh

    steps:
      - name: Checkout base repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Fetch PR changes
        shell: bash
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr
          git checkout pr

      - name: Find changed build.sh files
        id: files
        shell: bash
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep 'build.sh' || true)

          {
            echo "changed_files<<EOF"
            echo "$FILES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Lint build.sh (bash -n only)
        id: lint
        shell: bash
        run: |
          ERROR=0

          while read -r file; do
            [ -z "$file" ] && continue
            echo "üßπ Checking syntax: $file"
            chmod +x "$file"
            sed -i 's/\r$//' "$file"
            if ! bash -n "$file"; then
              echo "‚ùå Syntax error in $file"
              ERROR=1
            fi
          done <<< "${{ steps.files.outputs.changed_files }}"

          {
            echo "lint_status<<EOF"
            echo "$ERROR"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Validate build.sh content (SHA256, URL, VERSION)
        id: validate
        shell: bash
        run: |
          VALIDATION_ERROR=0
          VALIDATION_DETAILS=""

          while read -r file; do
            [ -z "$file" ] && continue
            
            echo "üîç Validating content: $file"
            
            # Extract variables from build.sh
            SRCURL=$(grep -E '^SRCURL=' "$file" | head -1 | cut -d'=' -f2- | tr -d '"' | tr -d "'")
            VERSION=$(grep -E '^VERSION=' "$file" | head -1 | cut -d'=' -f2- | tr -d '"' | tr -d "'")
            SHA256=$(grep -E '^SHA256=' "$file" | head -1 | cut -d'=' -f2- | tr -d '"' | tr -d "'")
            
            # Validation 1: Check if SRCURL is defined
            if [ -z "$SRCURL" ]; then
              echo "‚ùå SRCURL is not defined in $file"
              VALIDATION_ERROR=1
              VALIDATION_DETAILS="${VALIDATION_DETAILS}‚ùå $file: SRCURL not defined\n"
              continue
            fi
            
            # Validation 2: Check if VERSION is defined
            if [ -z "$VERSION" ]; then
              echo "‚ùå VERSION is not defined in $file"
              VALIDATION_ERROR=1
              VALIDATION_DETAILS="${VALIDATION_DETAILS}‚ùå $file: VERSION not defined\n"
              continue
            fi
            
            # Validation 3: Check if SHA256 is defined
            if [ -z "$SHA256" ]; then
              echo "‚ùå SHA256 is not defined in $file"
              VALIDATION_ERROR=1
              VALIDATION_DETAILS="${VALIDATION_DETAILS}‚ùå $file: SHA256 not defined\n"
              continue
            fi
            
            # Validation 4: Check if SHA256 format is valid (64 hex characters)
            if ! [[ "$SHA256" =~ ^[a-fA-F0-9]{64}$ ]]; then
              echo "‚ùå SHA256 format invalid in $file (must be 64 hex chars): $SHA256"
              VALIDATION_ERROR=1
              VALIDATION_DETAILS="${VALIDATION_DETAILS}‚ùå $file: Invalid SHA256 format\n"
              continue
            fi
            
            # Validation 5: Check if URL is valid (basic check)
            if ! [[ "$SRCURL" =~ ^https?:// ]]; then
              echo "‚ùå SRCURL is not a valid HTTP(S) URL in $file: $SRCURL"
              VALIDATION_ERROR=1
              VALIDATION_DETAILS="${VALIDATION_DETAILS}‚ùå $file: Invalid SRCURL format\n"
              continue
            fi
            
            # Validation 6: Construct download URL and verify SHA256
            echo "üì• Attempting to download from: $SRCURL"
            DOWNLOAD_URL="${SRCURL//\{VERSION\}/$VERSION}"
            
            # Try to download with timeout
            if timeout 60 curl -L -f -s -o /tmp/source_file "$DOWNLOAD_URL" 2>/dev/null; then
              COMPUTED_SHA256=$(sha256sum /tmp/source_file | awk '{print $1}')
              
              if [ "$COMPUTED_SHA256" = "$SHA256" ]; then
                echo "‚úÖ SHA256 verified for $file"
              else
                echo "‚ùå SHA256 mismatch in $file"
                echo "   Expected: $SHA256"
                echo "   Got:      $COMPUTED_SHA256"
                VALIDATION_ERROR=1
                VALIDATION_DETAILS="${VALIDATION_DETAILS}‚ùå $file: SHA256 mismatch\n   Expected: $SHA256\n   Got: $COMPUTED_SHA256\n"
              fi
              rm -f /tmp/source_file
            else
              echo "‚ö†Ô∏è  Warning: Could not download $DOWNLOAD_URL (URL may be unreachable or require auth)"
              echo "   Continuing without SHA256 verification for this file"
              VALIDATION_DETAILS="${VALIDATION_DETAILS}‚ö†Ô∏è  $file: Could not download to verify SHA256\n"
            fi
            
          done <<< "${{ steps.files.outputs.changed_files }}"

          {
            echo "validation_status<<EOF"
            echo "$VALIDATION_ERROR"
            echo "EOF"
            echo "validation_details<<EOF"
            echo -e "$VALIDATION_DETAILS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Determine overall status
        id: status
        shell: bash
        run: |
          LINT_STATUS="${{ steps.lint.outputs.lint_status }}"
          VALIDATION_STATUS="${{ steps.validate.outputs.validation_status }}"
          
          # If either lint or validation fails, overall status is failed
          if [ "$LINT_STATUS" = "1" ] || [ "$VALIDATION_STATUS" = "1" ]; then
            OVERALL_STATUS=1
          else
            OVERALL_STATUS=0
          fi
          
          {
            echo "overall_status<<EOF"
            echo "$OVERALL_STATUS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Remove old lint labels
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: review-approved, review-failed

      - name: Add review-approved label
        if: steps.status.outputs.overall_status == '0'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: review-approved

      - name: Add review-failed label
        if: steps.status.outputs.overall_status == '1'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: review-failed

      - name: Comment on PR with validation details
        if: steps.status.outputs.overall_status == '1'
        uses: actions/github-script@v8
        with:
          script: |
            const lintStatus = '${{ steps.lint.outputs.lint_status }}';
            const validationStatus = '${{ steps.validate.outputs.validation_status }}';
            const validationDetails = `${{ steps.validate.outputs.validation_details }}`;
            
            let comment = '## ‚ùå Lint Check Failed\n\n';
            
            if (lintStatus === '1') {
              comment += '### Bash Syntax Errors\n';
              comment += 'Your build.sh file contains bash syntax errors. Please fix them.\n\n';
            }
            
            if (validationStatus === '1') {
              comment += '### Validation Errors\n';
              comment += validationDetails || 'Please check your build.sh for the following:\n';
              comment += '- ‚úÖ SRCURL is defined and valid (http/https URL)\n';
              comment += '- ‚úÖ VERSION is defined\n';
              comment += '- ‚úÖ SHA256 is defined (64 hex characters)\n';
              comment += '- ‚úÖ SHA256 matches the downloaded file\n\n';
            }
            
            comment += '---\n';
            comment += '**Need help?** Check the [repository guidelines](https://github.com/djunekz/termux-app-store/blob/master/README.md)\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment on PR with success message
        if: steps.status.outputs.overall_status == '0'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ‚úÖ Lint Check Passed\n\nYour build.sh file has passed all validations:\n- ‚úÖ Bash syntax is correct\n- ‚úÖ SRCURL, VERSION, and SHA256 are properly defined\n- ‚úÖ SHA256 checksum matches the downloaded file\n\nReady for review!'
            });
