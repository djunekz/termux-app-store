name: Auto Update CHANGELOG

on:
  push:
    branches:
      - master
    paths:
      - 'packages/*/build.sh'

  workflow_dispatch: 
  
permissions:
  contents: write
  pull-requests: read

jobs:
  update-changelog:
    name: Update CHANGELOG.md
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          ref: ${{ github.ref_name }}

      - name: Configure Git
        run: |
          git config user.name "Termux App Store"
          git config user.email "258516621+termux-app-store@users.noreply.github.com"

      - name: Detect changed packages
        id: detect
        shell: bash
        run: |
          set -e

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.event.after }}"

          echo "=== Package Change Detection ==="
          echo "Branch: ${{ github.ref_name }}"
          echo "Range: $BEFORE...$AFTER"
          echo ""

          CHANGED=$(git diff --name-only "$BEFORE" "$AFTER" | grep 'packages/.*/build.sh' || true)

          if [ -z "$CHANGED" ]; then
            echo "No package changes detected"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Changed packages:"
          echo "$CHANGED"
          echo ""

          ADDED_FILE=$(mktemp)
          UPDATED_FILE=$(mktemp)
          META_FILE=$(mktemp)

          while IFS= read -r file; do
            [ -z "$file" ] && continue

            pkg=$(basename "$(dirname "$file")")
            echo "â†’ Processing: $pkg"

            ver=$(grep '^TERMUX_PKG_VERSION=' "$file" | head -1 | sed 's/^TERMUX_PKG_VERSION=//;s/["\x27]//g')
            desc=$(grep '^TERMUX_PKG_DESCRIPTION=' "$file" | head -1 | sed 's/^TERMUX_PKG_DESCRIPTION=//;s/["\x27]//g')

            if ! git cat-file -e "$BEFORE:$file" 2>/dev/null; then
              if [ -n "$desc" ]; then
                # Gunakan printf untuk hindari interpretasi backtick
                printf -- '- Package `%s` v%s - %s\n' "$pkg" "$ver" "$desc" >> "$ADDED_FILE"
              else
                printf -- '- Package `%s` v%s\n' "$pkg" "$ver" >> "$ADDED_FILE"
              fi
              echo "  Status: NEW (v${ver})"

            else

              old_ver=$(git show "$BEFORE:$file" | grep '^TERMUX_PKG_VERSION=' | head -1 | sed 's/^TERMUX_PKG_VERSION=//;s/["\x27]//g')
              new_ver="$ver"

              if [ "$old_ver" != "$new_ver" ]; then
                printf -- '- Package `%s` v%s â†’ v%s\n' "$pkg" "$old_ver" "$new_ver" >> "$UPDATED_FILE"
                echo "  Status: UPDATED ($old_ver â†’ $new_ver)"
              else

                if git diff "$BEFORE" "$AFTER" -- "$file" | grep -qE '^[+-]TERMUX_PKG_(SRCURL|SHA256|DEPENDS)='; then
                  printf -- '- Package `%s` v%s - Updated metadata\n' "$pkg" "$new_ver" >> "$META_FILE"
                  echo "  Status: METADATA CHANGED (v${new_ver})"
                fi
              fi
            fi
          done <<< "$CHANGED"

          ENTRIES_FILE=$(mktemp)

          if [ -s "$ADDED_FILE" ]; then
            printf '### Added\n' >> "$ENTRIES_FILE"
            cat "$ADDED_FILE" >> "$ENTRIES_FILE"
            printf '\n' >> "$ENTRIES_FILE"
          fi

          if [ -s "$UPDATED_FILE" ]; then
            printf '### Update\n' >> "$ENTRIES_FILE"
            cat "$UPDATED_FILE" >> "$ENTRIES_FILE"
            printf '\n' >> "$ENTRIES_FILE"
          fi

          if [ -s "$META_FILE" ]; then
            printf '### Changed\n' >> "$ENTRIES_FILE"
            cat "$META_FILE" >> "$ENTRIES_FILE"
            printf '\n' >> "$ENTRIES_FILE"
          fi

          # Cleanup temp files
          rm -f "$ADDED_FILE" "$UPDATED_FILE" "$META_FILE"

          if [ ! -s "$ENTRIES_FILE" ]; then
            echo "No significant changes"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            rm -f "$ENTRIES_FILE"
            exit 0
          fi

          echo ""
          echo "=== Generated Changelog Entries ==="
          cat "$ENTRIES_FILE"
          echo "===================================="

          echo "entries_file=$ENTRIES_FILE" >> "$GITHUB_OUTPUT"
          echo "has_changes=true" >> "$GITHUB_OUTPUT"

      - name: Update CHANGELOG.md
        if: steps.detect.outputs.has_changes == 'true'
        shell: bash
        run: |
          set -e

          ENTRIES_FILE="${{ steps.detect.outputs.entries_file }}"

          echo "=== Updating CHANGELOG.md ==="

          if [ ! -f "CHANGELOG.md" ]; then
            echo "ERROR: CHANGELOG.md not found"
            exit 1
          fi

          if [ ! -f "$ENTRIES_FILE" ]; then
            echo "ERROR: entries_file not found: $ENTRIES_FILE"
            exit 1
          fi

          awk -v entries_file="$ENTRIES_FILE" '
            /^## \[Unreleased\]/ {
              print $0
              while ((getline line < entries_file) > 0) {
                print line
              }
              close(entries_file)
              print "---"
              next
            }
            /^---$/ && !printed {
              printed = 1
              next
            }
            { print }
          ' CHANGELOG.md > CHANGELOG.md.tmp

          if [ ! -s CHANGELOG.md.tmp ]; then
            echo "ERROR: Failed to generate updated CHANGELOG"
            exit 1
          fi

          mv CHANGELOG.md.tmp CHANGELOG.md

          echo "âœ… CHANGELOG.md updated"
          echo ""
          echo "Added entries:"
          cat "$ENTRIES_FILE"

          # Cleanup
          rm -f "$ENTRIES_FILE"

      - name: Commit and push
        if: steps.detect.outputs.has_changes == 'true'
        shell: bash
        run: |
          set -e

          git add CHANGELOG.md

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "docs: update CHANGELOG [skip ci]"

          echo "Pushing to ${{ github.ref_name }}..."

          MAX_RETRIES=3
          RETRY=0

          while [ $RETRY -lt $MAX_RETRIES ]; do
            if git push origin "${{ github.ref_name }}"; then
              echo "âœ… Push successful"
              exit 0
            fi

            RETRY=$((RETRY + 1))
            echo "Push failed, retry $RETRY/$MAX_RETRIES"

            if [ $RETRY -lt $MAX_RETRIES ]; then
              git pull --rebase origin "${{ github.ref_name }}"
              sleep 2
            fi
          done

          echo "âŒ Push failed after $MAX_RETRIES attempts"
          exit 1

      - name: Summary
        if: steps.detect.outputs.has_changes == 'true'
        run: |
          echo "## ðŸ“ CHANGELOG Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "See CHANGELOG.md for details" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
