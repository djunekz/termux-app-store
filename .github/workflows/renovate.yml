name: Renovate PR Checker

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**/build.sh'
      - '**/package.json'
      - '**/Cargo.toml'
      - '**/requirements.txt'

jobs:
  renovate-check:
    if: github.actor == 'renovate[bot]'
    runs-on: ubuntu-latest
    name: Validate Renovate PR

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # -----------------------------
      # DETECT CHANGED FILES
      # -----------------------------
      - name: Detect changed build.sh files
        id: files
        shell: bash
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          FILES=$(git diff "$BASE_SHA"...HEAD --name-only | grep 'build.sh' || true)
          echo "files=$FILES" >> "$GITHUB_OUTPUT"

      # -----------------------------
      # LINT CHECKER (SYNTAX ONLY)
      # -----------------------------
      - name: Lint build.sh (syntax)
        if: steps.files.outputs.files != ''
        shell: bash
        run: |
          set -e
          ERROR=0
          for file in ${{ steps.files.outputs.files }}; do
            echo "üßπ Checking $file"
            sed -i 's/\r$//' "$file"
            if ! bash -n "$file"; then
              echo "‚ùå Syntax error in $file"
              ERROR=1
            else
              echo "‚úÖ Syntax OK"
            fi
          done
          if [ $ERROR -eq 1 ]; then
            exit 1
          fi

      # -----------------------------
      # METADATA CHECK (SAFE PARSE)
      # -----------------------------
      - name: Validate package metadata
        id: metadata
        shell: bash
        run: |
          FAIL=0

          PKGS=$(git diff "${{ github.event.pull_request.base.sha }}"...HEAD --name-only \
            | awk -F/ '/^packages\/[^/]+\/build.sh/{print $2}' \
            | sort -u)

          for PKG in $PKGS; do
            echo "üì¶ Checking $PKG"
            BUILD_SH="packages/$PKG/build.sh"

            get_var() {
              grep -E "^$1=" "$BUILD_SH" | head -n1 | cut -d= -f2-
            }

            VERSION=$(get_var TERMUX_PKG_VERSION)
            SRCURL=$(get_var TERMUX_PKG_SRCURL)
            SHA256=$(get_var TERMUX_PKG_SHA256)

            for v in VERSION SRCURL SHA256; do
              if [[ -z "${!v}" ]]; then
                echo "‚ùå Missing TERMUX_PKG_$v in $PKG"
                FAIL=1
              fi
            done

            if [[ -n "$SHA256" && ! "$SHA256" =~ ^[a-f0-9]{64}$ ]]; then
              echo "‚ùå Invalid SHA256 format in $PKG"
              FAIL=1
            fi
          done

          if [ $FAIL -eq 1 ]; then
            exit 1
          fi

      # -----------------------------
      # COMMENT RESULT
      # -----------------------------
      - name: Comment success
        if: success()
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ü§ñ **Renovate PR detected**
            ‚úÖ build.sh syntax check passed
            ‚úÖ Package metadata looks valid
            üîç Human review still required before merge

      - name: Comment failure
        if: failure()
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ü§ñ **Renovate PR detected**
            ‚ùå Lint or metadata check failed
            Please review the errors above before merging.
