name: Renovate PR Checker

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: read
  pull-requests: write

jobs:
  renovate-check:
    name: Renovate PR Checker
    runs-on: ubuntu-latest
    if: github.actor == 'renovate[bot]'

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Detect changed files
        id: files
        shell: bash
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          FILES=$(git diff "$BASE"...HEAD --name-only || true)

          {
            echo "files<<EOF"
            echo "$FILES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Skip if no relevant changes
        if: |
          !contains(steps.files.outputs.files, 'build.sh') &&
          !contains(steps.files.outputs.files, 'package.json') &&
          !contains(steps.files.outputs.files, 'Cargo.toml') &&
          !contains(steps.files.outputs.files, 'requirements.txt')
        run: |
          echo "‚ÑπÔ∏è No relevant files changed by Renovate"
          exit 0

      - name: Lint build.sh (syntax)
        if: contains(steps.files.outputs.files, 'build.sh')
        shell: bash
        run: |
          set -e
          while read -r file; do
            [[ "$file" != *build.sh ]] && continue
            echo "üßπ Checking $file"
            sed -i 's/\r$//' "$file"
            bash -n "$file"
          done <<< "${{ steps.files.outputs.files }}"

      - name: Validate package metadata
        shell: bash
        run: |
          set -e
          FAIL=0
          BASE="${{ github.event.pull_request.base.sha }}"

          PKGS=$(git diff "$BASE"...HEAD --name-only \
            | awk -F/ '/^packages\/[^/]+\/build.sh$/ {print $2}' \
            | sort -u)

          for PKG in $PKGS; do
            BUILD="packages/$PKG/build.sh"
            echo "üîç Validating $BUILD"

            get() { grep -E "^$1=" "$BUILD" | cut -d= -f2- | head -n1; }

            [[ -z "$(get TERMUX_PKG_VERSION)" ]] && FAIL=1
            [[ -z "$(get TERMUX_PKG_SRCURL)" ]] && FAIL=1
            [[ "$(get TERMUX_PKG_SHA256)" =~ ^[a-f0-9]{64}$ ]] || FAIL=1
          done

          [ "$FAIL" -eq 0 ]

      - name: Comment success
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ü§ñ **Renovate PR detected**
            ‚úÖ Syntax & metadata check passed
            üîí Manual review still required
